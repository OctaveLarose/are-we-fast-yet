# Max RSS

```{r load-scripts, echo=FALSE, include=FALSE}
# load libraries, the data, and prepare it
if (Sys.getenv("USER") == "smarr") {
  setwd("/Users/smarr/Projects/ast-vs-bc-interp/are-we-fast-yet/report/bc-vs-ast")
  } else if (Sys.getenv("USER") == "sopi") {
  setwd("/home/sopi/Documents/Writing/2023/ast-vs-bc-interp/are-we-fast-yet/report/bc-vs-ast/" )
  } else {
  setwd("/home/octavel/PhD/papers/ast-vs-bc-interp/are-we-fast-yet/report/bc-vs-ast")
  }
source("scripts/libraries.R", chdir=TRUE)
source("scripts/data-processing2.R")

#extrafont::font_import()
#print(extrafont::fonts())
#extrafont::loadfonts()
#extrafont::loadfonts(device = "postscript")

get_data_rss <- function() {
  # iteration is always 1 so we remove it. unit is always kb
  remove_unneeded_data <- function(df) {
    df <- df %>% 
      filter(criterion == "MaxRSS") %>% 
      subset(select = -c(commitid, cmdline, expid, varvalue, cores, inputsize, iteration, criterion, envid, unit))
    
    # group the data by runid and trialid, and keep only the first row of each group
    #df <- df %>%
    #  group_by(runid, trialid) %>%
    #  slice_head(n = 1) %>%
    #  mutate(invocation = NA, value = max(value)) %>%
    #  ungroup() %>%
    #  select(-invocation)
    
    df
  }

  #TODO NOT based on ast-vs-bc-baseline for TSOM. which probably isn't tremendously important, frankly
  data_rss_tsom <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2597") %>% remove_unneeded_data()
  #data_rss_pysom <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2596") %>% remove_unneeded_data()
  data_rss_pysom <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2615") %>% remove_unneeded_data()
  
#  towers <- data_rss_pysom %>% filter(bench == "Towers") %>% subset(select = -c(commitid, cmdline, expid, varvalue, cores, inputsize, iteration, envid))
  
  data_rss <- rbind(data_rss_tsom, data_rss_pysom)
  
  data_rss
}

get_data_program_representation <- function(data) {
  data_repr_tsom <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2622") %>% filter(criterion == "Allocated")
  data_repr_pysom <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2763")
  pysom_unique <- distinct(data_repr_pysom, exe, runid, cmdline, cores, extraargs, envid, .keep_all = TRUE)
  
  tsom_unique <- data_repr_tsom %>%
    group_by(expid, runid, trialid, bench, exe, cmdline, extraargs, invocation) %>%
    summarize(iteration = 1, value = sum(value))
  tsom_unique <- distinct(data_repr_tsom, exe, runid, cmdline, cores, extraargs, envid, .keep_all = TRUE)  
  
  data_repr <- rbind(pysom_unique, tsom_unique)
  
  data_repr
}

# Unused.
get_comparison_table <- function(all_data, exe_bc_name, exe_ast_name, only_with_warmup=FALSE) {
  df_filtered <- all_data %>%
  filter(exe %in% c(exe_bc_name, exe_ast_name))

  df_new <- df_filtered %>%
   group_by(bench) %>%
    summarize(bc_value = mean(value[exe == exe_bc_name]),
             ast_value = mean(value[exe == exe_ast_name]))

  df_new
}

box_plot_rss <- function(data, colors = color_set_vms) {
  x_breaks <- c(0.5, 0.8, 1, 2, 3, 5, 10, 15, 30)
  
  breaks <- levels(droplevels(data)$exe)

  plot <- ggplot(data, aes(x=ratio, y=reorder(exe, -ratio, FUN = median)))
  plot <- plot + 
    geom_vline(aes(xintercept=1),    colour="#999999", linetype="solid") +
    geom_vline(aes(xintercept=2), colour="#999999", linetype="dotted") +
    geom_vline(aes(xintercept=10), colour="#999999", linetype="dotted")
  plot <- plot + geom_boxplot(outlier.size = 0.9,
                              outlier.alpha = 0.6,
                              width=0.5,
                              outlier.shape = 22,
                              aes(colour = exe, fill = exe), 
                              alpha=0.4) +
    scale_x_log10(breaks = x_breaks) +
    scale_color_manual(values = colors) +
    scale_fill_manual(values = colors) +
    theme_bw() + theme_simple(font_size = 8) +
    theme(
      axis.text.x = element_text(angle= 90, vjust=0.5, hjust=1),
      axis.title.x  = element_text(size = 8, family="Arial"),
      legend.position="none") +
    #scale_y_log10(breaks=c(1,2,3,10,20,30,50,100,200,300,500,1000)) + #limit=c(0,30), breaks=seq(0,100,5), expand = c(0,0)
    ylab("") +
    xlab("")
  
  plot
}

box_plot_in_kb <- function(data, colors = color_set_vms) {
#  x_breaks <- c(0.5, 0.8, 1, 2, 3, 5, 10, 15, 30)
  
  breaks <- levels(droplevels(data)$exe)

  plot <- ggplot(data, aes(x=value.x, y=reorder(exe, -ratio, FUN = median)))
  plot <- plot + geom_boxplot(outlier.size = 0.9,
                              outlier.alpha = 0.6,
                              width=0.5,
                              outlier.shape = 22,
                              aes(colour = exe, fill = exe), 
                              alpha=0.4) +
    scale_x_log10() +
    scale_color_manual(values = colors) +
    scale_fill_manual(values = colors) +
    theme_bw() + theme_simple(font_size = 8) +
    theme(
      axis.text.x = element_text(angle= 90, vjust=0.5, hjust=1),
      axis.title.x  = element_text(size = 8, family="Arial"),
      legend.position="none") +
    #scale_y_log10(breaks=c(1,2,3,10,20,30,50,100,200,300,500,1000)) + #limit=c(0,30), breaks=seq(0,100,5), expand = c(0,0)
    ylab("") +
    xlab("")
  
  plot
}

get_data_for_box_plot <- function(all_data, baseline_name, exe_names=NULL) {
  if (!is.null(exe_names)) {
    df <- all_data %>% filter(exe %in% exe_names)
  } else {
    df <- all_data
  }

  df_baseline <- df %>% filter(exe == baseline_name)
  df2 <- df %>% left_join(
        df_baseline,
        by = c("bench", "extraargs", "invocation", "warmup"))
  
  colnames(df2)[which(colnames(df2) == "exe.x")] <- "exe"
  df2$ratio <- df2$value.x / df2$value.y

  suppressMessages(df2$exe <- revalue(df2$exe, unify_overview_memory_data) %>% droplevels())
  suppressMessages(df2$exe <- revalue(df2$exe, vm_names) %>% droplevels())
  df2
}

data_rss <- get_data_rss() 
data_repr_from_old_function <- get_data_program_representation()

#data_repr_tsom_old <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2622") %>% 
#    filter(criterion == "Allocated") %>%
#    group_by(expid, runid, trialid, bench, exe, cmdline, extraargs, invocation) %>%
#    summarize(iteration = 1, value = sum(value))

data_repr_tsom <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2838") %>% 
    filter(criterion == "Allocated") %>% 
    rename(value.x = value) %>% mutate(ratio = 1) # bad code to make it work with the previous boxplot function...

data_repr_pysom <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2860")
data_repr_pysom <- distinct(data_repr_pysom, exe, runid, cmdline, cores, extraargs, envid, .keep_all = TRUE)
```

## BCvsAST - interpreter only

```{r rss-interp, fig.width=8, fig.height=2.2, echo=FALSE}
#box_plot_data <- get_data_for_box_plot_rss(data_rss, 
#                                           "TruffleSOM-native-interp-bc",
#                                           c("TruffleSOM-native-interp-bc", "TruffleSOM-native-interp-ast"))

#box_plot_data <- get_data_for_box_plot_rss(data_rss, 
#                                           "RPySOM-bc-interp",
#                                           c("RPySOM-bc-interp", "RPySOM-ast-interp"))

box_plot_data <- get_data_for_box_plot(data_rss,
                                           "RPySOM-bc-interp",
                                           c("RPySOM-bc-interp", "RPySOM-ast-interp",
                                             "TruffleSOM-native-interp-bc", "TruffleSOM-native-interp-ast"))


#print(kable(df2), type="latex", comment=FALSE)
plot <- box_plot_rss(box_plot_data)
#ggsave("rss-interp.pdf", plot, dpi = 300, height = 200, width = 400, units="mm", device="pdf")
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/rss-interp.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot
```


## BCvsAST - JIT

```{r rss-jit, fig.width=8, fig.height=2.2, echo=FALSE}
#box_plot_data2 <- get_data_for_box_plot_rss(data_rss,
#                                      "RPySOM-bc-jit",
#                                       c("RPySOM-bc-jit", "RPySOM-ast-jit"))

box_plot_data <- get_data_for_box_plot(data_rss,
                                           "RPySOM-bc-jit",
                                           c("RPySOM-bc-jit", "RPySOM-ast-jit", "TruffleSOM-graal", "TruffleSOM-graal-bc"))


#print(kable(df2), type="latex", comment=FALSE)
plot <- box_plot_rss(box_plot_data)
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/rss-jit.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")
#ggsave(plot, device= cairo_pdf, path=".", filename="rss-jit.pdf", dpi=300, height=4, width=8.5, units="in", family="Arial")

plot
```

## BCvsAST - PySOM int

```{r rss-pysom-int, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot(data_rss,
                                           "RPySOM-bc-interp",
                                           c("RPySOM-bc-interp", "RPySOM-ast-interp"))

plot <- box_plot_in_kb(box_plot_data)
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/rss-interp-pysom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot
```

## BCvsAST - TruffleSOM int

```{r rss-tsom-int, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot(data_rss,
                                           "TruffleSOM-native-interp-bc",
                                           c("TruffleSOM-native-interp-bc", "TruffleSOM-native-interp-ast"))

plot <- box_plot_in_kb(box_plot_data)
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/rss-interp-tsom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot
```

## BCvsAST - PySOM JIT

```{r rss-pysom-jit, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot(data_rss,
                                           "RPySOM-bc-jit",
                                           c("RPySOM-bc-jit", "RPySOM-ast-jit"))

plot <- box_plot_in_kb(box_plot_data)
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/rss-jit-pysom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot
```

## BCvsAST - TruffleSOM JIT

```{r rss-tsom-jit, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot(data_rss,
                                           "TruffleSOM-graal-bc",
                                           c("TruffleSOM-graal", "TruffleSOM-graal-bc"))

plot <- box_plot_in_kb(box_plot_data)
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/rss-jit-tsom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot
```


# TSOM - runtime allocations

TSOM int: sum of any iteration above 10. TSOM JIT: sum of any iteration above 100 (not very scientific, overview for now)

## BCvsAST - TruffleSOM Int
```{r program-repr-memory-int-tsom, fig.width=8, fig.height=2.2, echo=FALSE}
data <- data_repr_tsom %>%
  filter(exe %in% c("TruffleSOM-native-interp-bc", "TruffleSOM-native-interp-ast")) %>%
  filter(iteration >= 10)

data <- data %>%
    group_by(expid, runid, trialid, bench, exe, cmdline, extraargs, invocation, ratio) %>%
    summarize(iteration = 1, value.x = sum(value.x))

plot <- box_plot_in_kb(data)
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/program-repr-interp-tsom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot
```

## BCvsAST - TruffleSOM Int (ratio)
```{r program-repr-memory-int-tsom-ratio, fig.width=8, fig.height=2.2, echo=FALSE}
df2 <- get_data_for_box_plot(data_repr_from_old_function,
                             "TruffleSOM-native-interp-bc",
                             c("TruffleSOM-native-interp-bc", "TruffleSOM-native-interp-ast"))
plot <- box_plot_rss(df2)
plot
```


## BCvsAST - TruffleSOM JIT
```{r program-repr-memory-jit-tsom, fig.width=8, fig.height=2.2, echo=FALSE}
data <- data_repr_tsom %>%
  filter(exe %in% c("TruffleSOM-graal", "TruffleSOM-graal-bc")) %>%
  filter(iteration >= 100)

data <- data %>%
    group_by(expid, runid, trialid, bench, exe, cmdline, extraargs, invocation, ratio) %>%
    summarize(iteration = 1, value.x = sum(value.x))

plot <- box_plot_in_kb(data)
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/program-repr-jit-tsom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot

```

## BCvsAST - TruffleSOM JIT (ratio)
```{r tsom-ratio-jit, fig.width=8, fig.height=2.2, echo=FALSE}
df2 <- get_data_for_box_plot(data_repr_from_old_function,
                             "TruffleSOM-graal-bc",
                             c("TruffleSOM-graal", "TruffleSOM-graal-bc"))
plot <- box_plot_rss(df2)
plot
```

# PySOM - runtime allocation.

### BCvsAST - PySOM Int
```{r program-repr-memory-int-pysom, fig.width=8, fig.height=2.2, echo=FALSE}
data <- data_repr_pysom %>% filter(exe %in% c("RPySOM-bc-interp", "RPySOM-ast-interp"))
data <- data %>% rename(value.x = value) %>% mutate(ratio = 1) # bad code to make it work with the previous boxplot function...

plot <- box_plot_in_kb(data)
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/program-repr-interp-pysom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot
```

## BCvsAST - PySOM Int (ratio)
```{r pysom-ratio-int, fig.width=8, fig.height=2.2, echo=FALSE}
df2 <- get_data_for_box_plot(data_repr_from_old_function,
                             "RPySOM-bc-interp",
                             c("RPySOM-bc-interp", "RPySOM-ast-interp"))
plot <- box_plot_rss(df2)
plot
```

### BCvsAST - PySOM JIT
```{r program-repr-memory-jit-pysom, fig.width=8, fig.height=2.2, echo=FALSE}
data <- data_repr_pysom %>% filter(exe %in% c("RPySOM-bc-jit", "RPySOM-ast-jit"))
data <- data %>% rename(value.x = value) %>% mutate(ratio = 1) # bad code to make it work with the previous boxplot function...

plot <- box_plot_in_kb(data)
ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/program-repr-jit-pysom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot
```

## BCvsAST - PySOM JIT (ratio)
```{r pysom-ratio-jit, fig.width=8, fig.height=2.2, echo=FALSE}
df2 <- get_data_for_box_plot(data_repr_from_old_function,
                             "RPySOM-bc-jit",
                             c("RPySOM-bc-jit", "RPySOM-ast-jit"))
plot <- box_plot_rss(df2)
plot
```

# TSOM - program repr., first iteration

## BCvsAST - TruffleSOM Int
```{r program-repr-1st-iter-memory-int-tsom, fig.width=8, fig.height=2.2, echo=FALSE}
data <- data_repr_tsom %>%
  filter(exe %in% c("TruffleSOM-native-interp-bc", "TruffleSOM-native-interp-ast")) %>%
  filter(iteration == 1)

data <- data %>%
    group_by(expid, runid, trialid, bench, exe, cmdline, extraargs, invocation, ratio) %>%
    summarize(iteration = 1, value.x = sum(value.x))

plot <- box_plot_in_kb(data)
#ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/program-repr-interp-tsom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot
```

## BCvsAST - TruffleSOM JIT

```{r program-repr-1st-iter-memory-jit-tsom, fig.width=8, fig.height=2.2, echo=FALSE}
data <- data_repr_tsom %>%
  filter(exe %in% c("TruffleSOM-graal", "TruffleSOM-graal-bc")) %>%
  filter(iteration == 1)

data <- data %>%
    group_by(expid, runid, trialid, bench, exe, cmdline, extraargs, invocation, ratio) %>%
    summarize(iteration = 1, value.x = sum(value.x))

plot <- box_plot_in_kb(data)
#ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/program-repr-jit-tsom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot

```

# Test benchmark

```{r test-bench-tsom, fig.width=8, fig.height=2.2, echo=FALSE}
data_tsom <- data_repr_tsom %>%
    filter(bench == "Test") %>%
    group_by(expid, runid, trialid, bench, exe, cmdline, extraargs, invocation, ratio) %>%
    summarize(iteration = 1, value.x = sum(value.x))

plot_tsom <- box_plot_in_kb(data_tsom)
#ggsave(plot, device= cairo_pdf, path=".", filename="output_graphs/program-repr-jit-tsom.pdf", dpi=300, height=50, width=100, units="mm", family="Arial")

plot_tsom
```

```{r test-bench-pysom, fig.width=8, fig.height=2.2, echo=FALSE}
data_pysom <- data_repr_pysom %>%
    filter(bench == "Test") %>% rename(value.x = value) %>% mutate(ratio = 1)

plot_pysom <- box_plot_in_kb(data_pysom)

plot_pysom
```