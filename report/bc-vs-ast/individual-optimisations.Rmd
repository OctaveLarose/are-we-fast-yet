# Impact of individual optimisations

## AST

```{r load-scripts, echo=FALSE, include=FALSE}
# load libraries, the data, and prepare it
if (Sys.getenv("RSTUDIO") == "1") { setwd("/home/octavel/PhD/papers/ast-vs-bc-interp/are-we-fast-yet/report/bc-vs-ast") }
source("scripts/libraries.R", chdir=TRUE)
source("scripts/data-processing2.R")

OPTIM_GRAPH_HEIGHT <- 50
OPTIM_GRAPH_WIDTH <- 100

#extrafont::font_import()
#print(extrafont::fonts())
#extrafont::loadfonts()
#extrafont::loadfonts(device = "postscript")

box_plot_optim <- function(data, custom_x_breaks=NULL) {
  if (is.null(custom_x_breaks))
    x_breaks <- c(0.5, 0.8, 1, 1.5, 2, 3, 5, 10, 15, 30, 50, 100, 300)
  else
    x_breaks <- custom_x_breaks
  
#  breaks <- levels(droplevels(data)$optim)
  #vm_colors <- rainbow(255)
  col_values <- rainbow(10)

  plot <- ggplot(data, aes(x=ratio, y=reorder(factor(optim), -ratio, FUN = median), fill = optim))
  plot <- plot + geom_boxplot(outlier.size = 0.5) +
    scale_x_log10(breaks = x_breaks) +
    scale_fill_viridis_d() +
    theme_bw() + theme_simple(font_size = 8) +
    theme(
      axis.text.x = element_text(angle= 90, vjust=0.5, hjust=1),
      axis.title.x  = element_text(size = 8, family="Arial"),
      legend.position="none") +
    #scale_y_log10(breaks=c(1,2,3,10,20,30,50,100,200,300,500,1000)) + #limit=c(0,30), breaks=seq(0,100,5), expand = c(0,0)
    ylab("") +
    xlab("")
  
  plot
}

# not deleting this as it's a reminder i want to make this graph. the idea was AST+BC data in a single graph for a given system, first the BC optimisations, then a horizontal line, then the AST optimisations
box_plot_optim_chatgpt_which_sucks <- function(data, custom_x_breaks=NULL) {
  if (is.null(custom_x_breaks))
    x_breaks <- c(0.5, 0.8, 1, 1.5, 2, 3, 5, 10, 15, 30)
  else
    x_breaks <- custom_x_breaks
  
  col_values <- rainbow(10)
  
  # Subset data by type "BC"
  data_bc <- subset(data, type == "BC")
  # Add random jitter to ratio values to avoid identical values
  data_bc$ratio <- jitter(data_bc$ratio, factor = 100)
  # Order data by ratio column
  data_bc <- data_bc[order(data_bc$ratio), ]
  
  # Subset data by type "AST"
  data_ast <- subset(data, type == "AST")
  # Add random jitter to ratio values to avoid identical values
  data_ast$ratio <- jitter(data_ast$ratio, factor = 100)
  # Order data by ratio column
  data_ast <- data_ast[order(data_ast$ratio), ]
  
  # Combine data with horizontal line
  data_combined <- rbind(data_bc, data.frame(ratio=c(0, 0), optim=unique(data$optim)[1], type=c("BC", "AST")))
  data_combined <- rbind(data_combined, data_ast)
  
  plot <- ggplot(data_combined, aes(x=ratio, y=reorder(factor(optim), -ratio, FUN = median), fill = optim))
  plot <- plot + geom_boxplot(outlier.size = 0.5) +
    scale_x_log10(breaks = x_breaks) +
    scale_fill_manual(values = get_safe_color_palette(4)) +
    theme_bw() + theme_simple(font_size = 8) +
    theme(
      axis.text.x = element_text(angle= 90, vjust=0.5, hjust=1),
      axis.title.x  = element_text(size = 8, family="Arial"),
      legend.position="none") +
    ylab("") +
    xlab("")
  
  plot
}

get_data_for_box_plot_optim <- function(input_data, exe_name, baseline_optim_name="every optimisation", optim_names=NULL) {
  grouped_iterations_data <- input_data %>%
    group_by(commitid, cmdline) %>%
    mutate(median_runtime = median(value)) %>%
    slice(1)
  
  df_baseline <- input_data %>% filter(optim == baseline_optim_name) %>%
    group_by(commitid, cmdline) %>%
    mutate(median_runtime = median(value)) %>%
    slice(1)
  
  box_plot_data <- grouped_iterations_data %>% left_join(
        df_baseline,
        by = c("exe", "bench", "extraargs", "iteration", "invocation", "warmup"))
  box_plot_data <- box_plot_data %>% filter(exe == exe_name)

  box_plot_data$ratio <- box_plot_data$median_runtime.x / box_plot_data$median_runtime.y
  #box_plot_data$ratio <- box_plot_data$value.x / box_plot_data$value.y
    
  # Renaming
  colnames(box_plot_data)[which(colnames(box_plot_data) == "optim.x")] <- "optim"
  
  
  if (!is.null(optim_names))
    box_plot_data <- box_plot_data %>% filter(optim %in% optim_names)
  
  box_plot_data
}


get_tsom_ast_data <- function() {
  based_on_what <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2622") %>% mutate(optim = "every optimisation")
  no_localnonlocal_vars <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2626") %>% mutate(optim = "no local/nonlocal vars")
  no_inline_caching <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2624") %>% mutate(optim = "no inline caching")
  no_global_caching <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2623") %>% mutate(optim = "no global caching")
  no_lower_prims <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2669") %>% mutate(optim = "no lowered control structs")
  no_blocks_without_context <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2625") %>% mutate(optim = "no blocks without context")
  
  data_optim <- rbind(based_on_what, no_localnonlocal_vars, no_inline_caching, 
                               no_global_caching, no_lower_prims, no_blocks_without_context) %>% filter(criterion == "total")
  data_optim
}

get_pysom_ast_data <- function() {
  based_on_what <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2662") %>% mutate(optim = "every optimisation")
  no_localnonlocal_vars <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2665") %>% mutate(optim = "no local/nonlocal vars")
  no_inline_caching <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2657") %>% mutate(optim = "no inline caching")
  no_global_caching <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2656") %>% mutate(optim = "no global caching")
  no_lowered_control_structs <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2663") %>% mutate(optim = "no lowered control structs")
  no_blocks_without_context <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2658") %>% mutate(optim = "no blocks without context")
  
  data_optim <- rbind(based_on_what, no_localnonlocal_vars, no_inline_caching,
                                no_global_caching, no_lowered_control_structs, no_blocks_without_context) %>% filter(criterion == "total")
  data_optim
}

get_tsom_bc_data <- function() {
  based_on_what <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2622") %>% mutate(optim = "every optimisation")
  no_bc_inline_caching <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2632") %>% mutate(optim = "no inline caching")
  no_quickening <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2678") %>% mutate(optim = "no quickening")
  no_global_caching <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2631") %>% mutate(optim = "no global caching")
  no_global_caching_2 <- load_data_url("https://rebench.stefan-marr.de/TruffleSOM/data/2683") %>% mutate(optim = "no global caching, second approach")
  no_lowered_control_structs <- "TODO"
  no_superinstructions <- "TODO"
  
  data_optim <- rbind(based_on_what, no_bc_inline_caching, no_quickening, no_global_caching, no_global_caching_2) %>% filter(criterion == "total")
  data_optim
}

get_pysom_bc_data <- function() {
  based_on_what <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2662") %>% mutate(optim = "every optimisation")
  no_bc_inline_caching <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2657") %>% mutate(optim = "no inline caching")
  no_lowered_control_structs <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2668") %>% mutate(optim = "no lowered control structs")
  no_global_caching <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2679") %>% mutate(optim = "no global caching")
  no_quickening <- load_data_url("https://rebench.stefan-marr.de/RPySOM/data/2682") %>% mutate(optim = "no quickening")
  no_superinstructions <- "TODO"
  
  data_optim <- rbind(based_on_what, no_bc_inline_caching, no_lowered_control_structs, no_global_caching, no_quickening) %>% filter(criterion == "total")
  data_optim
}

data_optim_tsom_ast <- get_tsom_ast_data()
data_optim_tsom_bc <- get_tsom_bc_data()
data_optim_pysom_ast <- get_pysom_ast_data()
data_optim_pysom_bc <- get_pysom_bc_data()
```

### Unified graph attempt
```{r yeah-mr-white-science, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data_ast <- get_data_for_box_plot_optim(data_optim_tsom_ast, "TruffleSOM-native-interp-ast") 
#%>% mutate(type = "BC")
box_plot_data_bc <- get_data_for_box_plot_optim(data_optim_tsom_bc, "TruffleSOM-native-interp-bc") 
#%>% mutate(type = "AST")

box_plot_data <- rbind(box_plot_data_ast, box_plot_data_bc)
plot <- box_plot_optim(box_plot_data)
#ggsave(plot, device= cairo_pdf, path=".", filename="optim-tsom-ast-int.pdf", dpi=300, height=OPTIM_GRAPH_HEIGHT, width=OPTIM_GRAPH_WIDTH, units="mm", family="Arial")
plot
```


### TruffleSOM - AST interp

```{r optim-tsom-ast-int, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot_optim(data_optim_tsom_ast, "TruffleSOM-native-interp-ast")
plot <- box_plot_optim(box_plot_data)
ggsave(plot, device= cairo_pdf, path=".", filename="optim-tsom-ast-int.pdf", dpi=300, height=OPTIM_GRAPH_HEIGHT, width=OPTIM_GRAPH_WIDTH, units="mm", family="Arial")
plot
```

### PySOM - AST interp

```{r optim-pysom-ast-int, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot_optim(data_optim_pysom_ast, "RPySOM-ast-interp")

plot <- box_plot_optim(box_plot_data, custom_x_breaks=c(1, 1.5, 1.8))
ggsave(plot, device= cairo_pdf, path=".", filename="optim-pysom-ast-int.pdf", dpi=300, height=OPTIM_GRAPH_HEIGHT, width=OPTIM_GRAPH_WIDTH, units="mm", family="Arial")
plot
```

### TruffleSOM - AST JIT

```{r optim-tsom-ast-jit, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot_optim(data_optim_tsom_ast, "TruffleSOM-graal")

plot <- box_plot_optim(box_plot_data)
ggsave(plot, device= cairo_pdf, path=".", filename="optim-tsom-ast-jit.pdf", dpi=300, height=OPTIM_GRAPH_HEIGHT, width=OPTIM_GRAPH_WIDTH, units="mm", family="Arial")
plot
```

### PySOM - AST JIT

```{r optim-pysom-ast-jit, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot_optim(data_optim_pysom_ast, "RPySOM-ast-jit")
plot <- box_plot_optim(box_plot_data)
ggsave(plot, device= cairo_pdf, path=".", filename="optim-pysom-ast-jit.pdf", dpi=300, height=OPTIM_GRAPH_HEIGHT, width=OPTIM_GRAPH_WIDTH, units="mm", family="Arial")
plot
```

## BC

### TruffleSOM - BC interp

```{r optim-tsom-bc-interp, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot_optim(data_optim_tsom_bc, "TruffleSOM-native-interp-bc")
plot <- box_plot_optim(box_plot_data)
plot
```

### PySOM - BC interp

```{r optim-pysom-bc-interp, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot_optim(data_optim_pysom_bc, "RPySOM-bc-interp")
plot <- box_plot_optim(box_plot_data)
plot
```

### TruffleSOM - BC JIT

```{r optim-tsom-bc-jit, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot_optim(data_optim_tsom_bc, "TruffleSOM-graal-bc")
plot <- box_plot_optim(box_plot_data)
plot
```

### PySOM - BC JIT

```{r optim-pysom-bc-jit, fig.width=8, fig.height=2.2, echo=FALSE}
box_plot_data <- get_data_for_box_plot_optim(data_optim_pysom_bc, "RPySOM-bc-jit")
plot <- box_plot_optim(box_plot_data)
plot
```
